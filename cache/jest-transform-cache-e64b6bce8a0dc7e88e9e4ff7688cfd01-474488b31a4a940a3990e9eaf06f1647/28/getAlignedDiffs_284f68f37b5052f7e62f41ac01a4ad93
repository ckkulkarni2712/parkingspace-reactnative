8bde382488048174183d0eca8bbe6a5e
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.default = void 0;
var _cleanupSemantic = require('./cleanupSemantic');
var concatenateRelevantDiffs = function concatenateRelevantDiffs(op, diffs, changeColor) {
  return diffs.reduce(function (reduced, diff) {
    return reduced + (diff[0] === _cleanupSemantic.DIFF_EQUAL ? diff[1] : diff[0] === op && diff[1].length !== 0 ? changeColor(diff[1]) : '');
  }, '');
};
var ChangeBuffer = function () {
  function ChangeBuffer(op, changeColor) {
    (0, _classCallCheck2.default)(this, ChangeBuffer);
    this.op = void 0;
    this.line = void 0;
    this.lines = void 0;
    this.changeColor = void 0;
    this.op = op;
    this.line = [];
    this.lines = [];
    this.changeColor = changeColor;
  }
  (0, _createClass2.default)(ChangeBuffer, [{
    key: "pushSubstring",
    value: function pushSubstring(substring) {
      this.pushDiff(new _cleanupSemantic.Diff(this.op, substring));
    }
  }, {
    key: "pushLine",
    value: function pushLine() {
      this.lines.push(this.line.length !== 1 ? new _cleanupSemantic.Diff(this.op, concatenateRelevantDiffs(this.op, this.line, this.changeColor)) : this.line[0][0] === this.op ? this.line[0] : new _cleanupSemantic.Diff(this.op, this.line[0][1]));
      this.line.length = 0;
    }
  }, {
    key: "isLineEmpty",
    value: function isLineEmpty() {
      return this.line.length === 0;
    }
  }, {
    key: "pushDiff",
    value: function pushDiff(diff) {
      this.line.push(diff);
    }
  }, {
    key: "align",
    value: function align(diff) {
      var _this = this;
      var string = diff[1];
      if (string.includes('\n')) {
        var substrings = string.split('\n');
        var iLast = substrings.length - 1;
        substrings.forEach(function (substring, i) {
          if (i < iLast) {
            _this.pushSubstring(substring);
            _this.pushLine();
          } else if (substring.length !== 0) {
            _this.pushSubstring(substring);
          }
        });
      } else {
        this.pushDiff(diff);
      }
    }
  }, {
    key: "moveLinesTo",
    value: function moveLinesTo(lines) {
      if (!this.isLineEmpty()) {
        this.pushLine();
      }
      lines.push.apply(lines, (0, _toConsumableArray2.default)(this.lines));
      this.lines.length = 0;
    }
  }]);
  return ChangeBuffer;
}();
var CommonBuffer = function () {
  function CommonBuffer(deleteBuffer, insertBuffer) {
    (0, _classCallCheck2.default)(this, CommonBuffer);
    this.deleteBuffer = void 0;
    this.insertBuffer = void 0;
    this.lines = void 0;
    this.deleteBuffer = deleteBuffer;
    this.insertBuffer = insertBuffer;
    this.lines = [];
  }
  (0, _createClass2.default)(CommonBuffer, [{
    key: "pushDiffCommonLine",
    value: function pushDiffCommonLine(diff) {
      this.lines.push(diff);
    }
  }, {
    key: "pushDiffChangeLines",
    value: function pushDiffChangeLines(diff) {
      var isDiffEmpty = diff[1].length === 0;
      if (!isDiffEmpty || this.deleteBuffer.isLineEmpty()) {
        this.deleteBuffer.pushDiff(diff);
      }
      if (!isDiffEmpty || this.insertBuffer.isLineEmpty()) {
        this.insertBuffer.pushDiff(diff);
      }
    }
  }, {
    key: "flushChangeLines",
    value: function flushChangeLines() {
      this.deleteBuffer.moveLinesTo(this.lines);
      this.insertBuffer.moveLinesTo(this.lines);
    }
  }, {
    key: "align",
    value: function align(diff) {
      var _this2 = this;
      var op = diff[0];
      var string = diff[1];
      if (string.includes('\n')) {
        var substrings = string.split('\n');
        var iLast = substrings.length - 1;
        substrings.forEach(function (substring, i) {
          if (i === 0) {
            var subdiff = new _cleanupSemantic.Diff(op, substring);
            if (_this2.deleteBuffer.isLineEmpty() && _this2.insertBuffer.isLineEmpty()) {
              _this2.flushChangeLines();
              _this2.pushDiffCommonLine(subdiff);
            } else {
              _this2.pushDiffChangeLines(subdiff);
              _this2.flushChangeLines();
            }
          } else if (i < iLast) {
            _this2.pushDiffCommonLine(new _cleanupSemantic.Diff(op, substring));
          } else if (substring.length !== 0) {
            _this2.pushDiffChangeLines(new _cleanupSemantic.Diff(op, substring));
          }
        });
      } else {
        this.pushDiffChangeLines(diff);
      }
    }
  }, {
    key: "getLines",
    value: function getLines() {
      this.flushChangeLines();
      return this.lines;
    }
  }]);
  return CommonBuffer;
}();
var getAlignedDiffs = function getAlignedDiffs(diffs, changeColor) {
  var deleteBuffer = new ChangeBuffer(_cleanupSemantic.DIFF_DELETE, changeColor);
  var insertBuffer = new ChangeBuffer(_cleanupSemantic.DIFF_INSERT, changeColor);
  var commonBuffer = new CommonBuffer(deleteBuffer, insertBuffer);
  diffs.forEach(function (diff) {
    switch (diff[0]) {
      case _cleanupSemantic.DIFF_DELETE:
        deleteBuffer.align(diff);
        break;
      case _cleanupSemantic.DIFF_INSERT:
        insertBuffer.align(diff);
        break;
      default:
        commonBuffer.align(diff);
    }
  });
  return commonBuffer.getLines();
};
var _default = getAlignedDiffs;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImRlZmF1bHQiLCJfY2xlYW51cFNlbWFudGljIiwicmVxdWlyZSIsImNvbmNhdGVuYXRlUmVsZXZhbnREaWZmcyIsIm9wIiwiZGlmZnMiLCJjaGFuZ2VDb2xvciIsInJlZHVjZSIsInJlZHVjZWQiLCJkaWZmIiwiRElGRl9FUVVBTCIsImxlbmd0aCIsIkNoYW5nZUJ1ZmZlciIsImxpbmUiLCJsaW5lcyIsInN1YnN0cmluZyIsInB1c2hEaWZmIiwiRGlmZiIsInB1c2giLCJzdHJpbmciLCJpbmNsdWRlcyIsInN1YnN0cmluZ3MiLCJzcGxpdCIsImlMYXN0IiwiZm9yRWFjaCIsImkiLCJwdXNoU3Vic3RyaW5nIiwicHVzaExpbmUiLCJpc0xpbmVFbXB0eSIsIkNvbW1vbkJ1ZmZlciIsImRlbGV0ZUJ1ZmZlciIsImluc2VydEJ1ZmZlciIsImlzRGlmZkVtcHR5IiwibW92ZUxpbmVzVG8iLCJzdWJkaWZmIiwiZmx1c2hDaGFuZ2VMaW5lcyIsInB1c2hEaWZmQ29tbW9uTGluZSIsInB1c2hEaWZmQ2hhbmdlTGluZXMiLCJnZXRBbGlnbmVkRGlmZnMiLCJESUZGX0RFTEVURSIsIkRJRkZfSU5TRVJUIiwiY29tbW9uQnVmZmVyIiwiYWxpZ24iLCJnZXRMaW5lcyIsIl9kZWZhdWx0Il0sInNvdXJjZXMiOlsiZ2V0QWxpZ25lZERpZmZzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7XG52YXIgX2NsZWFudXBTZW1hbnRpYyA9IHJlcXVpcmUoJy4vY2xlYW51cFNlbWFudGljJyk7XG4vKipcbiAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuLy8gR2l2ZW4gY2hhbmdlIG9wIGFuZCBhcnJheSBvZiBkaWZmcywgcmV0dXJuIGNvbmNhdGVuYXRlZCBzdHJpbmc6XG4vLyAqIGluY2x1ZGUgY29tbW9uIHN0cmluZ3Ncbi8vICogaW5jbHVkZSBjaGFuZ2Ugc3RyaW5ncyB3aGljaCBoYXZlIGFyZ3VtZW50IG9wIHdpdGggY2hhbmdlQ29sb3Jcbi8vICogZXhjbHVkZSBjaGFuZ2Ugc3RyaW5ncyB3aGljaCBoYXZlIG9wcG9zaXRlIG9wXG5jb25zdCBjb25jYXRlbmF0ZVJlbGV2YW50RGlmZnMgPSAob3AsIGRpZmZzLCBjaGFuZ2VDb2xvcikgPT5cbiAgZGlmZnMucmVkdWNlKFxuICAgIChyZWR1Y2VkLCBkaWZmKSA9PlxuICAgICAgcmVkdWNlZCArXG4gICAgICAoZGlmZlswXSA9PT0gX2NsZWFudXBTZW1hbnRpYy5ESUZGX0VRVUFMXG4gICAgICAgID8gZGlmZlsxXVxuICAgICAgICA6IGRpZmZbMF0gPT09IG9wICYmIGRpZmZbMV0ubGVuZ3RoICE9PSAwIC8vIGVtcHR5IGlmIGNoYW5nZSBpcyBuZXdsaW5lXG4gICAgICAgID8gY2hhbmdlQ29sb3IoZGlmZlsxXSlcbiAgICAgICAgOiAnJyksXG4gICAgJydcbiAgKTtcblxuLy8gRW5jYXBzdWxhdGUgY2hhbmdlIGxpbmVzIHVudGlsIGVpdGhlciBhIGNvbW1vbiBuZXdsaW5lIG9yIHRoZSBlbmQuXG5jbGFzcyBDaGFuZ2VCdWZmZXIge1xuICBvcDtcbiAgbGluZTsgLy8gaW5jb21wbGV0ZSBsaW5lXG4gIGxpbmVzOyAvLyBjb21wbGV0ZSBsaW5lc1xuICBjaGFuZ2VDb2xvcjtcbiAgY29uc3RydWN0b3Iob3AsIGNoYW5nZUNvbG9yKSB7XG4gICAgdGhpcy5vcCA9IG9wO1xuICAgIHRoaXMubGluZSA9IFtdO1xuICAgIHRoaXMubGluZXMgPSBbXTtcbiAgICB0aGlzLmNoYW5nZUNvbG9yID0gY2hhbmdlQ29sb3I7XG4gIH1cbiAgcHVzaFN1YnN0cmluZyhzdWJzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2hEaWZmKG5ldyBfY2xlYW51cFNlbWFudGljLkRpZmYodGhpcy5vcCwgc3Vic3RyaW5nKSk7XG4gIH1cbiAgcHVzaExpbmUoKSB7XG4gICAgLy8gQXNzdW1lIGNhbGwgb25seSBpZiBsaW5lIGhhcyBhdCBsZWFzdCBvbmUgZGlmZixcbiAgICAvLyB0aGVyZWZvcmUgYW4gZW1wdHkgbGluZSBtdXN0IGhhdmUgYSBkaWZmIHdoaWNoIGhhcyBhbiBlbXB0eSBzdHJpbmcuXG5cbiAgICAvLyBJZiBsaW5lIGhhcyBtdWx0aXBsZSBkaWZmcywgdGhlbiBhc3N1bWUgaXQgaGFzIGEgY29tbW9uIGRpZmYsXG4gICAgLy8gdGhlcmVmb3JlIGNoYW5nZSBkaWZmcyBoYXZlIGNoYW5nZSBjb2xvcjtcbiAgICAvLyBvdGhlcndpc2UgdGhlbiBpdCBoYXMgbGluZSBjb2xvciBvbmx5LlxuICAgIHRoaXMubGluZXMucHVzaChcbiAgICAgIHRoaXMubGluZS5sZW5ndGggIT09IDFcbiAgICAgICAgPyBuZXcgX2NsZWFudXBTZW1hbnRpYy5EaWZmKFxuICAgICAgICAgICAgdGhpcy5vcCxcbiAgICAgICAgICAgIGNvbmNhdGVuYXRlUmVsZXZhbnREaWZmcyh0aGlzLm9wLCB0aGlzLmxpbmUsIHRoaXMuY2hhbmdlQ29sb3IpXG4gICAgICAgICAgKVxuICAgICAgICA6IHRoaXMubGluZVswXVswXSA9PT0gdGhpcy5vcFxuICAgICAgICA/IHRoaXMubGluZVswXSAvLyBjYW4gdXNlIGluc3RhbmNlXG4gICAgICAgIDogbmV3IF9jbGVhbnVwU2VtYW50aWMuRGlmZih0aGlzLm9wLCB0aGlzLmxpbmVbMF1bMV0pIC8vIHdhcyBjb21tb24gZGlmZlxuICAgICk7XG5cbiAgICB0aGlzLmxpbmUubGVuZ3RoID0gMDtcbiAgfVxuICBpc0xpbmVFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5saW5lLmxlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIC8vIE1pbm9yIGlucHV0IHRvIGJ1ZmZlci5cbiAgcHVzaERpZmYoZGlmZikge1xuICAgIHRoaXMubGluZS5wdXNoKGRpZmYpO1xuICB9XG5cbiAgLy8gTWFpbiBpbnB1dCB0byBidWZmZXIuXG4gIGFsaWduKGRpZmYpIHtcbiAgICBjb25zdCBzdHJpbmcgPSBkaWZmWzFdO1xuICAgIGlmIChzdHJpbmcuaW5jbHVkZXMoJ1xcbicpKSB7XG4gICAgICBjb25zdCBzdWJzdHJpbmdzID0gc3RyaW5nLnNwbGl0KCdcXG4nKTtcbiAgICAgIGNvbnN0IGlMYXN0ID0gc3Vic3RyaW5ncy5sZW5ndGggLSAxO1xuICAgICAgc3Vic3RyaW5ncy5mb3JFYWNoKChzdWJzdHJpbmcsIGkpID0+IHtcbiAgICAgICAgaWYgKGkgPCBpTGFzdCkge1xuICAgICAgICAgIC8vIFRoZSBmaXJzdCBzdWJzdHJpbmcgY29tcGxldGVzIHRoZSBjdXJyZW50IGNoYW5nZSBsaW5lLlxuICAgICAgICAgIC8vIEEgbWlkZGxlIHN1YnN0cmluZyBpcyBhIGNoYW5nZSBsaW5lLlxuICAgICAgICAgIHRoaXMucHVzaFN1YnN0cmluZyhzdWJzdHJpbmcpO1xuICAgICAgICAgIHRoaXMucHVzaExpbmUoKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdWJzdHJpbmcubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgLy8gVGhlIGxhc3Qgc3Vic3RyaW5nIHN0YXJ0cyBhIGNoYW5nZSBsaW5lLCBpZiBpdCBpcyBub3QgZW1wdHkuXG4gICAgICAgICAgLy8gSW1wb3J0YW50OiBUaGlzIG5vbi1lbXB0eSBjb25kaXRpb24gYWxzbyBhdXRvbWF0aWNhbGx5IG9taXRzXG4gICAgICAgICAgLy8gdGhlIG5ld2xpbmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiBleHBlY3RlZCBhbmQgcmVjZWl2ZWQgc3RyaW5ncy5cbiAgICAgICAgICB0aGlzLnB1c2hTdWJzdHJpbmcoc3Vic3RyaW5nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEFwcGVuZCBub24tbXVsdGlsaW5lIHN0cmluZyB0byBjdXJyZW50IGNoYW5nZSBsaW5lLlxuICAgICAgdGhpcy5wdXNoRGlmZihkaWZmKTtcbiAgICB9XG4gIH1cblxuICAvLyBPdXRwdXQgZnJvbSBidWZmZXIuXG4gIG1vdmVMaW5lc1RvKGxpbmVzKSB7XG4gICAgaWYgKCF0aGlzLmlzTGluZUVtcHR5KCkpIHtcbiAgICAgIHRoaXMucHVzaExpbmUoKTtcbiAgICB9XG4gICAgbGluZXMucHVzaCguLi50aGlzLmxpbmVzKTtcbiAgICB0aGlzLmxpbmVzLmxlbmd0aCA9IDA7XG4gIH1cbn1cblxuLy8gRW5jYXBzdWxhdGUgY29tbW9uIGFuZCBjaGFuZ2UgbGluZXMuXG5jbGFzcyBDb21tb25CdWZmZXIge1xuICBkZWxldGVCdWZmZXI7XG4gIGluc2VydEJ1ZmZlcjtcbiAgbGluZXM7XG4gIGNvbnN0cnVjdG9yKGRlbGV0ZUJ1ZmZlciwgaW5zZXJ0QnVmZmVyKSB7XG4gICAgdGhpcy5kZWxldGVCdWZmZXIgPSBkZWxldGVCdWZmZXI7XG4gICAgdGhpcy5pbnNlcnRCdWZmZXIgPSBpbnNlcnRCdWZmZXI7XG4gICAgdGhpcy5saW5lcyA9IFtdO1xuICB9XG4gIHB1c2hEaWZmQ29tbW9uTGluZShkaWZmKSB7XG4gICAgdGhpcy5saW5lcy5wdXNoKGRpZmYpO1xuICB9XG4gIHB1c2hEaWZmQ2hhbmdlTGluZXMoZGlmZikge1xuICAgIGNvbnN0IGlzRGlmZkVtcHR5ID0gZGlmZlsxXS5sZW5ndGggPT09IDA7XG5cbiAgICAvLyBBbiBlbXB0eSBkaWZmIHN0cmluZyBpcyByZWR1bmRhbnQsIHVubGVzcyBhIGNoYW5nZSBsaW5lIGlzIGVtcHR5LlxuICAgIGlmICghaXNEaWZmRW1wdHkgfHwgdGhpcy5kZWxldGVCdWZmZXIuaXNMaW5lRW1wdHkoKSkge1xuICAgICAgdGhpcy5kZWxldGVCdWZmZXIucHVzaERpZmYoZGlmZik7XG4gICAgfVxuICAgIGlmICghaXNEaWZmRW1wdHkgfHwgdGhpcy5pbnNlcnRCdWZmZXIuaXNMaW5lRW1wdHkoKSkge1xuICAgICAgdGhpcy5pbnNlcnRCdWZmZXIucHVzaERpZmYoZGlmZik7XG4gICAgfVxuICB9XG4gIGZsdXNoQ2hhbmdlTGluZXMoKSB7XG4gICAgdGhpcy5kZWxldGVCdWZmZXIubW92ZUxpbmVzVG8odGhpcy5saW5lcyk7XG4gICAgdGhpcy5pbnNlcnRCdWZmZXIubW92ZUxpbmVzVG8odGhpcy5saW5lcyk7XG4gIH1cblxuICAvLyBJbnB1dCB0byBidWZmZXIuXG4gIGFsaWduKGRpZmYpIHtcbiAgICBjb25zdCBvcCA9IGRpZmZbMF07XG4gICAgY29uc3Qgc3RyaW5nID0gZGlmZlsxXTtcbiAgICBpZiAoc3RyaW5nLmluY2x1ZGVzKCdcXG4nKSkge1xuICAgICAgY29uc3Qgc3Vic3RyaW5ncyA9IHN0cmluZy5zcGxpdCgnXFxuJyk7XG4gICAgICBjb25zdCBpTGFzdCA9IHN1YnN0cmluZ3MubGVuZ3RoIC0gMTtcbiAgICAgIHN1YnN0cmluZ3MuZm9yRWFjaCgoc3Vic3RyaW5nLCBpKSA9PiB7XG4gICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgY29uc3Qgc3ViZGlmZiA9IG5ldyBfY2xlYW51cFNlbWFudGljLkRpZmYob3AsIHN1YnN0cmluZyk7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy5kZWxldGVCdWZmZXIuaXNMaW5lRW1wdHkoKSAmJlxuICAgICAgICAgICAgdGhpcy5pbnNlcnRCdWZmZXIuaXNMaW5lRW1wdHkoKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgLy8gSWYgYm90aCBjdXJyZW50IGNoYW5nZSBsaW5lcyBhcmUgZW1wdHksXG4gICAgICAgICAgICAvLyB0aGVuIHRoZSBmaXJzdCBzdWJzdHJpbmcgaXMgYSBjb21tb24gbGluZS5cbiAgICAgICAgICAgIHRoaXMuZmx1c2hDaGFuZ2VMaW5lcygpO1xuICAgICAgICAgICAgdGhpcy5wdXNoRGlmZkNvbW1vbkxpbmUoc3ViZGlmZik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIElmIGVpdGhlciBjdXJyZW50IGNoYW5nZSBsaW5lIGlzIG5vbi1lbXB0eSxcbiAgICAgICAgICAgIC8vIHRoZW4gdGhlIGZpcnN0IHN1YnN0cmluZyBjb21wbGV0ZXMgdGhlIGNoYW5nZSBsaW5lcy5cbiAgICAgICAgICAgIHRoaXMucHVzaERpZmZDaGFuZ2VMaW5lcyhzdWJkaWZmKTtcbiAgICAgICAgICAgIHRoaXMuZmx1c2hDaGFuZ2VMaW5lcygpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChpIDwgaUxhc3QpIHtcbiAgICAgICAgICAvLyBBIG1pZGRsZSBzdWJzdHJpbmcgaXMgYSBjb21tb24gbGluZS5cbiAgICAgICAgICB0aGlzLnB1c2hEaWZmQ29tbW9uTGluZShuZXcgX2NsZWFudXBTZW1hbnRpYy5EaWZmKG9wLCBzdWJzdHJpbmcpKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdWJzdHJpbmcubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgLy8gVGhlIGxhc3Qgc3Vic3RyaW5nIHN0YXJ0cyBhIGNoYW5nZSBsaW5lLCBpZiBpdCBpcyBub3QgZW1wdHkuXG4gICAgICAgICAgLy8gSW1wb3J0YW50OiBUaGlzIG5vbi1lbXB0eSBjb25kaXRpb24gYWxzbyBhdXRvbWF0aWNhbGx5IG9taXRzXG4gICAgICAgICAgLy8gdGhlIG5ld2xpbmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiBleHBlY3RlZCBhbmQgcmVjZWl2ZWQgc3RyaW5ncy5cbiAgICAgICAgICB0aGlzLnB1c2hEaWZmQ2hhbmdlTGluZXMobmV3IF9jbGVhbnVwU2VtYW50aWMuRGlmZihvcCwgc3Vic3RyaW5nKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBBcHBlbmQgbm9uLW11bHRpbGluZSBzdHJpbmcgdG8gY3VycmVudCBjaGFuZ2UgbGluZXMuXG4gICAgICAvLyBJbXBvcnRhbnQ6IEl0IGNhbm5vdCBiZSBhdCB0aGUgZW5kIGZvbGxvd2luZyBlbXB0eSBjaGFuZ2UgbGluZXMsXG4gICAgICAvLyBiZWNhdXNlIG5ld2xpbmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiBleHBlY3RlZCBhbmQgcmVjZWl2ZWQgc3RyaW5ncy5cbiAgICAgIHRoaXMucHVzaERpZmZDaGFuZ2VMaW5lcyhkaWZmKTtcbiAgICB9XG4gIH1cblxuICAvLyBPdXRwdXQgZnJvbSBidWZmZXIuXG4gIGdldExpbmVzKCkge1xuICAgIHRoaXMuZmx1c2hDaGFuZ2VMaW5lcygpO1xuICAgIHJldHVybiB0aGlzLmxpbmVzO1xuICB9XG59XG5cbi8vIEdpdmVuIGRpZmZzIGZyb20gZXhwZWN0ZWQgYW5kIHJlY2VpdmVkIHN0cmluZ3MsXG4vLyByZXR1cm4gbmV3IGFycmF5IG9mIGRpZmZzIHNwbGl0IG9yIGpvaW5lZCBpbnRvIGxpbmVzLlxuLy9cbi8vIFRvIGNvcnJlY3RseSBhbGlnbiBhIGNoYW5nZSBsaW5lIGF0IHRoZSBlbmQsIHRoZSBhbGdvcml0aG06XG4vLyAqIGFzc3VtZXMgdGhhdCBhIG5ld2xpbmUgd2FzIGFwcGVuZGVkIHRvIHRoZSBzdHJpbmdzXG4vLyAqIG9taXRzIHRoZSBsYXN0IG5ld2xpbmUgZnJvbSB0aGUgb3V0cHV0IGFycmF5XG4vL1xuLy8gQXNzdW1lIHRoZSBmdW5jdGlvbiBpcyBub3QgY2FsbGVkOlxuLy8gKiBpZiBlaXRoZXIgZXhwZWN0ZWQgb3IgcmVjZWl2ZWQgaXMgZW1wdHkgc3RyaW5nXG4vLyAqIGlmIG5laXRoZXIgZXhwZWN0ZWQgbm9yIHJlY2VpdmVkIGlzIG11bHRpbGluZSBzdHJpbmdcbmNvbnN0IGdldEFsaWduZWREaWZmcyA9IChkaWZmcywgY2hhbmdlQ29sb3IpID0+IHtcbiAgY29uc3QgZGVsZXRlQnVmZmVyID0gbmV3IENoYW5nZUJ1ZmZlcihcbiAgICBfY2xlYW51cFNlbWFudGljLkRJRkZfREVMRVRFLFxuICAgIGNoYW5nZUNvbG9yXG4gICk7XG4gIGNvbnN0IGluc2VydEJ1ZmZlciA9IG5ldyBDaGFuZ2VCdWZmZXIoXG4gICAgX2NsZWFudXBTZW1hbnRpYy5ESUZGX0lOU0VSVCxcbiAgICBjaGFuZ2VDb2xvclxuICApO1xuICBjb25zdCBjb21tb25CdWZmZXIgPSBuZXcgQ29tbW9uQnVmZmVyKGRlbGV0ZUJ1ZmZlciwgaW5zZXJ0QnVmZmVyKTtcbiAgZGlmZnMuZm9yRWFjaChkaWZmID0+IHtcbiAgICBzd2l0Y2ggKGRpZmZbMF0pIHtcbiAgICAgIGNhc2UgX2NsZWFudXBTZW1hbnRpYy5ESUZGX0RFTEVURTpcbiAgICAgICAgZGVsZXRlQnVmZmVyLmFsaWduKGRpZmYpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgX2NsZWFudXBTZW1hbnRpYy5ESUZGX0lOU0VSVDpcbiAgICAgICAgaW5zZXJ0QnVmZmVyLmFsaWduKGRpZmYpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbW1vbkJ1ZmZlci5hbGlnbihkaWZmKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gY29tbW9uQnVmZmVyLmdldExpbmVzKCk7XG59O1xudmFyIF9kZWZhdWx0ID0gZ2V0QWxpZ25lZERpZmZzO1xuZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBQUM7QUFBQTtBQUFBO0FBQUE7QUFFYkEsTUFBTSxDQUFDQyxjQUFjLENBQUNDLE9BQU8sRUFBRSxZQUFZLEVBQUU7RUFDM0NDLEtBQUssRUFBRTtBQUNULENBQUMsQ0FBQztBQUNGRCxPQUFPLENBQUNFLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDeEIsSUFBSUMsZ0JBQWdCLEdBQUdDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztBQVluRCxJQUFNQyx3QkFBd0IsR0FBRyxTQUEzQkEsd0JBQXdCLENBQUlDLEVBQUUsRUFBRUMsS0FBSyxFQUFFQyxXQUFXO0VBQUEs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