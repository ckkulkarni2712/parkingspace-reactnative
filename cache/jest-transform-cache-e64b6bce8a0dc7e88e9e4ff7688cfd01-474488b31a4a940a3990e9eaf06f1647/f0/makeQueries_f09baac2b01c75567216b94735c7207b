56ef6cea9c57c8988d93bfc1e3ab27ee
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeQueries = makeQueries;
var _errors = require("../helpers/errors");
var _waitFor = _interopRequireDefault(require("../waitFor"));
function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}
var deprecatedKeys = ['timeout', 'interval', 'stackTraceError'];
function extractDeprecatedWaitForOptions(options) {
  if (!options) {
    return undefined;
  }
  var waitForOptions = {
    timeout: options.timeout,
    interval: options.interval,
    stackTraceError: options.stackTraceError
  };
  deprecatedKeys.forEach(function (key) {
    var option = options[key];
    if (option) {
      console.warn("Use of option \"" + key + "\" in a findBy* query options (2nd parameter) is deprecated. Please pass this option in the waitForOptions (3rd parameter). \nExample: \n\n  findByText(text, {}, { " + key + ": " + option.toString() + " })");
    }
  });
  return waitForOptions;
}
function makeQueries(queryAllByQuery, getMissingError, getMultipleError) {
  function getAllByQuery(instance) {
    return function getAllFn(predicate, options) {
      var results = queryAllByQuery(instance)(predicate, options);
      if (results.length === 0) {
        throw new _errors.ErrorWithStack(getMissingError(predicate, options), getAllFn);
      }
      return results;
    };
  }
  function queryByQuery(instance) {
    return function singleQueryFn(predicate, options) {
      var results = queryAllByQuery(instance)(predicate, options);
      if (results.length > 1) {
        throw new _errors.ErrorWithStack(getMultipleError(predicate, options), singleQueryFn);
      }
      if (results.length === 0) {
        return null;
      }
      return results[0];
    };
  }
  function getByQuery(instance) {
    return function getFn(predicate, options) {
      var results = queryAllByQuery(instance)(predicate, options);
      if (results.length > 1) {
        throw new _errors.ErrorWithStack(getMultipleError(predicate, options), getFn);
      }
      if (results.length === 0) {
        throw new _errors.ErrorWithStack(getMissingError(predicate, options), getFn);
      }
      return results[0];
    };
  }
  function findAllByQuery(instance) {
    return function findAllFn(predicate, queryOptions) {
      var waitForOptions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
      var deprecatedWaitForOptions = extractDeprecatedWaitForOptions(queryOptions);
      return (0, _waitFor.default)(function () {
        return getAllByQuery(instance)(predicate, queryOptions);
      }, Object.assign({}, deprecatedWaitForOptions, waitForOptions));
    };
  }
  function findByQuery(instance) {
    return function findFn(predicate, queryOptions) {
      var waitForOptions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
      var deprecatedWaitForOptions = extractDeprecatedWaitForOptions(queryOptions);
      return (0, _waitFor.default)(function () {
        return getByQuery(instance)(predicate, queryOptions);
      }, Object.assign({}, deprecatedWaitForOptions, waitForOptions));
    };
  }
  return {
    getBy: getByQuery,
    getAllBy: getAllByQuery,
    queryBy: queryByQuery,
    queryAllBy: queryAllByQuery,
    findBy: findByQuery,
    findAllBy: findAllByQuery
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUNuQixDQUFDO0VBQ0g7RUFFQSxTQUFTTyxjQUFjLENBQUNWLFFBQTJCLEVBQUU7SUFDbkQsT0FBTyxTQUFTVyxTQUFTLENBQ3ZCVCxTQUFvQixFQUNwQlUsWUFBdUMsRUFFdkM7TUFBQSxJQURBM0IsY0FBOEIsdUVBQUcsQ0FBQyxDQUFDO01BRW5DLElBQU00Qix3QkFBd0IsR0FDNUIvQiwrQkFBK0IsQ0FBQzhCLFlBQVksQ0FBQztNQUMvQyxPQUFPLG9CQUFPLEVBQUM7UUFBQSxPQUFNYixhQUFhLENBQUNDLFFBQVEsQ0FBQyxDQUFDRSxTQUFTLEVBQUVVLFlBQVksQ0FBQztNQUFBLHFCQUNoRUMsd0JBQXdCLEVBQ3hCNUIsZ0JBQ0g7SUFDSixDQUFDO0VBQ0g7RUFFQSxTQUFTNkIsV0FBVyxDQUFDZCxRQUEyQixFQUFFO0lBQ2hELE9BQU8sU0FBU2UsTUFBTSxDQUNwQmIsU0FBb0IsRUFDcEJVLFlBQXVDLEVBRXZDO01BQUEsSUFEQTNCLGNBQThCLHVFQUFHLENBQUMsQ0FBQztNQUVuQyxJQUFNNEIsd0JBQXdCLEdBQzVCL0IsK0JBQStCLENBQUM4QixZQUFZLENBQUM7TUFDL0MsT0FBTyxvQkFBTyxFQUFDO1FBQUEsT0FBTUosVUFBVSxDQUFDUixRQUFRLENBQUMsQ0FBQ0UsU0FBUyxFQUFFVSxZQUFZLENBQUM7TUFBQSxxQkFDN0RDLHdCQUF3QixFQUN4QjVCLGdCQUNIO0lBQ0osQ0FBQztFQUNIO0VBRUEsT0FBTztJQUNMK0IsS0FBSyxFQUFFUixVQUFVO0lBQ2pCUyxRQUFRLEVBQUVsQixhQUFhO0lBQ3ZCbUIsT0FBTyxFQUFFWixZQUFZO0lBQ3JCYSxVQUFVLEVBQUV2QixlQUFlO0lBQzNCd0IsTUFBTSxFQUFFTixXQUFXO0lBQ25CTyxTQUFTLEVBQUVYO0VBQ2IsQ0FBQztBQUNIIiwibmFtZXMiOlsiZGVmYXVsdCIsImRlcHJlY2F0ZWRLZXlzIiwiZXh0cmFjdERlcHJlY2F0ZWRXYWl0Rm9yT3B0aW9ucyIsIm9wdGlvbnMiLCJ1bmRlZmluZWQiLCJ3YWl0Rm9yT3B0aW9ucyIsInRpbWVvdXQiLCJpbnRlcnZhbCIsInN0YWNrVHJhY2VFcnJvciIsImZvckVhY2giLCJrZXkiLCJvcHRpb24iLCJjb25zb2xlIiwid2FybiIsInRvU3RyaW5nIiwibWFrZVF1ZXJpZXMiLCJxdWVyeUFsbEJ5UXVlcnkiLCJnZXRNaXNzaW5nRXJyb3IiLCJnZXRNdWx0aXBsZUVycm9yIiwiZ2V0QWxsQnlRdWVyeSIsImluc3RhbmNlIiwiZ2V0QWxsRm4iLCJwcmVkaWNhdGUiLCJyZXN1bHRzIiwibGVuZ3RoIiwiRXJyb3JXaXRoU3RhY2siLCJxdWVyeUJ5UXVlcnkiLCJzaW5nbGVRdWVyeUZuIiwiZ2V0QnlRdWVyeSIsImdldEZuIiwiZmluZEFsbEJ5UXVlcnkiLCJmaW5kQWxsRm4iLCJxdWVyeU9wdGlvbnMiLCJkZXByZWNhdGVkV2FpdEZvck9wdGlvbnMiLCJmaW5kQnlRdWVyeSIsImZpbmRGbiIsImdldEJ5IiwiZ2V0QWxsQnkiLCJxdWVyeUJ5IiwicXVlcnlBbGxCeSIsImZpbmRCeSIsImZpbmRBbGxCeSJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL21ha2VRdWVyaWVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUmVhY3RUZXN0SW5zdGFuY2UgfSBmcm9tICdyZWFjdC10ZXN0LXJlbmRlcmVyJztcbmltcG9ydCB7IEVycm9yV2l0aFN0YWNrIH0gZnJvbSAnLi4vaGVscGVycy9lcnJvcnMnO1xuaW1wb3J0IHdhaXRGb3IgZnJvbSAnLi4vd2FpdEZvcic7XG5pbXBvcnQgdHlwZSB7IFdhaXRGb3JPcHRpb25zIH0gZnJvbSAnLi4vd2FpdEZvcic7XG5cbmV4cG9ydCB0eXBlIEdldEJ5UXVlcnk8UHJlZGljYXRlLCBPcHRpb25zID0gdm9pZD4gPSAoXG4gIHByZWRpY2F0ZTogUHJlZGljYXRlLFxuICBvcHRpb25zPzogT3B0aW9uc1xuKSA9PiBSZWFjdFRlc3RJbnN0YW5jZTtcblxuZXhwb3J0IHR5cGUgR2V0QWxsQnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnMgPSB2b2lkPiA9IChcbiAgcHJlZGljYXRlOiBQcmVkaWNhdGUsXG4gIG9wdGlvbnM/OiBPcHRpb25zXG4pID0+IFJlYWN0VGVzdEluc3RhbmNlW107XG5cbmV4cG9ydCB0eXBlIFF1ZXJ5QnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnMgPSB2b2lkPiA9IChcbiAgcHJlZGljYXRlOiBQcmVkaWNhdGUsXG4gIG9wdGlvbnM/OiBPcHRpb25zXG4pID0+IFJlYWN0VGVzdEluc3RhbmNlIHwgbnVsbDtcblxuZXhwb3J0IHR5cGUgUXVlcnlBbGxCeVF1ZXJ5PFByZWRpY2F0ZSwgT3B0aW9ucyA9IHZvaWQ+ID0gKFxuICBwcmVkaWNhdGU6IFByZWRpY2F0ZSxcbiAgb3B0aW9ucz86IE9wdGlvbnNcbikgPT4gUmVhY3RUZXN0SW5zdGFuY2VbXTtcblxuZXhwb3J0IHR5cGUgRmluZEJ5UXVlcnk8UHJlZGljYXRlLCBPcHRpb25zID0gdm9pZD4gPSAoXG4gIHByZWRpY2F0ZTogUHJlZGljYXRlLFxuICAvLyBSZW1vdmUgYCYgV2FpdEZvck9wdGlvbnNgIHdoZW4gYWxsIHF1ZXJpZXMgaGF2ZSBiZWVuIG1pZ3JhdGVkIHRvIHN1cHBvcnQgMm5kIGFyZyBxdWVyeSBvcHRpb25zLlxuICBvcHRpb25zPzogT3B0aW9ucyAmIFdhaXRGb3JPcHRpb25zLFxuICB3YWl0Rm9yT3B0aW9ucz86IFdhaXRGb3JPcHRpb25zXG4pID0+IFByb21pc2U8UmVhY3RUZXN0SW5zdGFuY2U+O1xuXG5leHBvcnQgdHlwZSBGaW5kQWxsQnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnMgPSB2b2lkPiA9IChcbiAgcHJlZGljYXRlOiBQcmVkaWNhdGUsXG4gIC8vIFJlbW92ZSBgJiBXYWl0Rm9yT3B0aW9uc2Agd2hlbiBhbGwgcXVlcmllcyBoYXZlIGJlZW4gbWlncmF0ZWQgdG8gc3VwcG9ydCAybmQgYXJnIHF1ZXJ5IG9wdGlvbnMuXG4gIG9wdGlvbnM/OiBPcHRpb25zICYgV2FpdEZvck9wdGlvbnMsXG4gIHdhaXRGb3JPcHRpb25zPzogV2FpdEZvck9wdGlvbnNcbikgPT4gUHJvbWlzZTxSZWFjdFRlc3RJbnN0YW5jZVtdPjtcblxudHlwZSBVbmJvdW5kUXVlcnk8UXVlcnk+ID0gKGluc3RhbmNlOiBSZWFjdFRlc3RJbnN0YW5jZSkgPT4gUXVlcnk7XG5cbmV4cG9ydCB0eXBlIFVuYm91bmRRdWVyaWVzPFByZWRpY2F0ZSwgT3B0aW9ucz4gPSB7XG4gIGdldEJ5OiBVbmJvdW5kUXVlcnk8R2V0QnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnM+PjtcbiAgZ2V0QWxsQnk6IFVuYm91bmRRdWVyeTxHZXRBbGxCeVF1ZXJ5PFByZWRpY2F0ZSwgT3B0aW9ucz4+O1xuICBxdWVyeUJ5OiBVbmJvdW5kUXVlcnk8UXVlcnlCeVF1ZXJ5PFByZWRpY2F0ZSwgT3B0aW9ucz4+O1xuICBxdWVyeUFsbEJ5OiBVbmJvdW5kUXVlcnk8UXVlcnlBbGxCeVF1ZXJ5PFByZWRpY2F0ZSwgT3B0aW9ucz4+O1xuICBmaW5kQnk6IFVuYm91bmRRdWVyeTxGaW5kQnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnM+PjtcbiAgZmluZEFsbEJ5OiBVbmJvdW5kUXVlcnk8RmluZEFsbEJ5UXVlcnk8UHJlZGljYXRlLCBPcHRpb25zPj47XG59O1xuXG5jb25zdCBkZXByZWNhdGVkS2V5czogKGtleW9mIFdhaXRGb3JPcHRpb25zKVtdID0gW1xuICAndGltZW91dCcsXG4gICdpbnRlcnZhbCcsXG4gICdzdGFja1RyYWNlRXJyb3InLFxuXTtcblxuLy8gVGhlIFdhaXRGb3JPcHRpb25zIGhhcyBiZWVuIG1vdmVkIHRvIHRoZSBzZWNvbmQgb3B0aW9uIHBhcmFtIG9mIGZpbmRCeSogbWV0aG9kcyB3aXRoIHRoZSBhZGRpbmcgb2YgVGV4dE1hdGNoT3B0aW9uc1xuLy8gVG8gbWFrZSB0aGUgbWlncmF0aW9uIGVhc2llciBhbmQgYXZvaWQgYSBicmVha2luZyBjaGFuZ2UsIGtlZXAgcmVhZGluZyB0aGlzIG9wdGlvbnMgZnJvbSB0aGUgZmlyc3QgcGFyYW0gYnV0IHdhcm5cbmZ1bmN0aW9uIGV4dHJhY3REZXByZWNhdGVkV2FpdEZvck9wdGlvbnMob3B0aW9ucz86IFdhaXRGb3JPcHRpb25zKSB7XG4gIGlmICghb3B0aW9ucykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCB3YWl0Rm9yT3B0aW9uczogV2FpdEZvck9wdGlvbnMgPSB7XG4gICAgdGltZW91dDogb3B0aW9ucy50aW1lb3V0LFxuICAgIGludGVydmFsOiBvcHRpb25zLmludGVydmFsLFxuICAgIHN0YWNrVHJhY2VFcnJvcjogb3B0aW9ucy5zdGFja1RyYWNlRXJyb3IsXG4gIH07XG5cbiAgZGVwcmVjYXRlZEtleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3Qgb3B0aW9uID0gb3B0aW9uc1trZXldO1xuICAgIGlmIChvcHRpb24pIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBVc2Ugb2Ygb3B0aW9uIFwiJHtrZXl9XCIgaW4gYSBmaW5kQnkqIHF1ZXJ5IG9wdGlvbnMgKDJuZCBwYXJhbWV0ZXIpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBwYXNzIHRoaXMgb3B0aW9uIGluIHRoZSB3YWl0Rm9yT3B0aW9ucyAoM3JkIHBhcmFtZXRlcikuIFxuRXhhbXBsZTogXG5cbiAgZmluZEJ5VGV4dCh0ZXh0LCB7fSwgeyAke2tleX06ICR7b3B0aW9uLnRvU3RyaW5nKCl9IH0pYFxuICAgICAgKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiB3YWl0Rm9yT3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VRdWVyaWVzPFByZWRpY2F0ZSwgT3B0aW9ucz4oXG4gIHF1ZXJ5QWxsQnlRdWVyeTogVW5ib3VuZFF1ZXJ5PFF1ZXJ5QWxsQnlRdWVyeTxQcmVkaWNhdGUsIE9wdGlvbnM+PixcbiAgZ2V0TWlzc2luZ0Vycm9yOiAocHJlZGljYXRlOiBQcmVkaWNhdGUsIG9wdGlvbnM/OiBPcHRpb25zKSA9PiBzdHJpbmcsXG4gIGdldE11bHRpcGxlRXJyb3I6IChwcmVkaWNhdGU6IFByZWRpY2F0ZSwgb3B0aW9ucz86IE9wdGlvbnMpID0+IHN0cmluZ1xuKTogVW5ib3VuZFF1ZXJpZXM8UHJlZGljYXRlLCBPcHRpb25zPiB7XG4gIGZ1bmN0aW9uIGdldEFsbEJ5UXVlcnkoaW5zdGFuY2U6IFJlYWN0VGVzdEluc3RhbmNlKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIGdldEFsbEZuKHByZWRpY2F0ZTogUHJlZGljYXRlLCBvcHRpb25zPzogT3B0aW9ucykge1xuICAgICAgY29uc3QgcmVzdWx0cyA9IHF1ZXJ5QWxsQnlRdWVyeShpbnN0YW5jZSkocHJlZGljYXRlLCBvcHRpb25zKTtcblxuICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcldpdGhTdGFjayhnZXRNaXNzaW5nRXJyb3IocHJlZGljYXRlLCBvcHRpb25zKSwgZ2V0QWxsRm4pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gcXVlcnlCeVF1ZXJ5KGluc3RhbmNlOiBSZWFjdFRlc3RJbnN0YW5jZSkge1xuICAgIHJldHVybiBmdW5jdGlvbiBzaW5nbGVRdWVyeUZuKHByZWRpY2F0ZTogUHJlZGljYXRlLCBvcHRpb25zPzogT3B0aW9ucykge1xuICAgICAgY29uc3QgcmVzdWx0cyA9IHF1ZXJ5QWxsQnlRdWVyeShpbnN0YW5jZSkocHJlZGljYXRlLCBvcHRpb25zKTtcblxuICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3JXaXRoU3RhY2soXG4gICAgICAgICAgZ2V0TXVsdGlwbGVFcnJvcihwcmVkaWNhdGUsIG9wdGlvbnMpLFxuICAgICAgICAgIHNpbmdsZVF1ZXJ5Rm5cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0c1swXTtcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnlRdWVyeShpbnN0YW5jZTogUmVhY3RUZXN0SW5zdGFuY2UpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gZ2V0Rm4ocHJlZGljYXRlOiBQcmVkaWNhdGUsIG9wdGlvbnM/OiBPcHRpb25zKSB7XG4gICAgICBjb25zdCByZXN1bHRzID0gcXVlcnlBbGxCeVF1ZXJ5KGluc3RhbmNlKShwcmVkaWNhdGUsIG9wdGlvbnMpO1xuXG4gICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcldpdGhTdGFjayhnZXRNdWx0aXBsZUVycm9yKHByZWRpY2F0ZSwgb3B0aW9ucyksIGdldEZuKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcldpdGhTdGFjayhnZXRNaXNzaW5nRXJyb3IocHJlZGljYXRlLCBvcHRpb25zKSwgZ2V0Rm4pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0c1swXTtcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gZmluZEFsbEJ5UXVlcnkoaW5zdGFuY2U6IFJlYWN0VGVzdEluc3RhbmNlKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIGZpbmRBbGxGbihcbiAgICAgIHByZWRpY2F0ZTogUHJlZGljYXRlLFxuICAgICAgcXVlcnlPcHRpb25zPzogT3B0aW9ucyAmIFdhaXRGb3JPcHRpb25zLFxuICAgICAgd2FpdEZvck9wdGlvbnM6IFdhaXRGb3JPcHRpb25zID0ge31cbiAgICApIHtcbiAgICAgIGNvbnN0IGRlcHJlY2F0ZWRXYWl0Rm9yT3B0aW9ucyA9XG4gICAgICAgIGV4dHJhY3REZXByZWNhdGVkV2FpdEZvck9wdGlvbnMocXVlcnlPcHRpb25zKTtcbiAgICAgIHJldHVybiB3YWl0Rm9yKCgpID0+IGdldEFsbEJ5UXVlcnkoaW5zdGFuY2UpKHByZWRpY2F0ZSwgcXVlcnlPcHRpb25zKSwge1xuICAgICAgICAuLi5kZXByZWNhdGVkV2FpdEZvck9wdGlvbnMsXG4gICAgICAgIC4uLndhaXRGb3JPcHRpb25zLFxuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGZpbmRCeVF1ZXJ5KGluc3RhbmNlOiBSZWFjdFRlc3RJbnN0YW5jZSkge1xuICAgIHJldHVybiBmdW5jdGlvbiBmaW5kRm4oXG4gICAgICBwcmVkaWNhdGU6IFByZWRpY2F0ZSxcbiAgICAgIHF1ZXJ5T3B0aW9ucz86IE9wdGlvbnMgJiBXYWl0Rm9yT3B0aW9ucyxcbiAgICAgIHdhaXRGb3JPcHRpb25zOiBXYWl0Rm9yT3B0aW9ucyA9IHt9XG4gICAgKSB7XG4gICAgICBjb25zdCBkZXByZWNhdGVkV2FpdEZvck9wdGlvbnMgPVxuICAgICAgICBleHRyYWN0RGVwcmVjYXRlZFdhaXRGb3JPcHRpb25zKHF1ZXJ5T3B0aW9ucyk7XG4gICAgICByZXR1cm4gd2FpdEZvcigoKSA9PiBnZXRCeVF1ZXJ5KGluc3RhbmNlKShwcmVkaWNhdGUsIHF1ZXJ5T3B0aW9ucyksIHtcbiAgICAgICAgLi4uZGVwcmVjYXRlZFdhaXRGb3JPcHRpb25zLFxuICAgICAgICAuLi53YWl0Rm9yT3B0aW9ucyxcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldEJ5OiBnZXRCeVF1ZXJ5LFxuICAgIGdldEFsbEJ5OiBnZXRBbGxCeVF1ZXJ5LFxuICAgIHF1ZXJ5Qnk6IHF1ZXJ5QnlRdWVyeSxcbiAgICBxdWVyeUFsbEJ5OiBxdWVyeUFsbEJ5UXVlcnksXG4gICAgZmluZEJ5OiBmaW5kQnlRdWVyeSxcbiAgICBmaW5kQWxsQnk6IGZpbmRBbGxCeVF1ZXJ5LFxuICB9O1xufVxuIl19