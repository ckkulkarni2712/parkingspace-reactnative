7a2f564a17453573b53087a1784fa3ea
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _reactNative = require("react-native");
var _act = _interopRequireDefault(require("./act"));
var _componentTree = require("./helpers/component-tree");
var _filterNodeByType = require("./helpers/filterNodeByType");
var _hostComponentNames = require("./helpers/host-component-names");
function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}
var isTextInput = function isTextInput(element) {
  if (!element) {
    return false;
  }
  return (0, _filterNodeByType.filterNodeByType)(element, _reactNative.TextInput) || (0, _filterNodeByType.filterNodeByType)(element, (0, _hostComponentNames.getHostComponentNames)().textInput);
};
var isTouchResponder = function isTouchResponder(element) {
  if (!(0, _componentTree.isHostElement)(element)) return false;
  return !!(element != null && element.props.onStartShouldSetResponder) || isTextInput(element);
};
var isPointerEventEnabled = function isPointerEventEnabled(element, isParent) {
  var parentCondition = isParent ? (element == null ? void 0 : element.props.pointerEvents) === 'box-only' : (element == null ? void 0 : element.props.pointerEvents) === 'box-none';
  if ((element == null ? void 0 : element.props.pointerEvents) === 'none' || parentCondition) {
    return false;
  }
  if (!(element != null && element.parent)) return true;
  return isPointerEventEnabled(element.parent, true);
};
var isTouchEvent = function isTouchEvent(eventName) {
  return eventName === 'press';
};
var isEventEnabled = function isEventEnabled(element, touchResponder, eventName) {
  if (isTextInput(element)) return (element == null ? void 0 : element.props.editable) !== false;
  if (!isPointerEventEnabled(element) && isTouchEvent(eventName)) return false;
  var touchStart = touchResponder == null ? void 0 : touchResponder.props.onStartShouldSetResponder == null ? void 0 : touchResponder.props.onStartShouldSetResponder();
  var touchMove = touchResponder == null ? void 0 : touchResponder.props.onMoveShouldSetResponder == null ? void 0 : touchResponder.props.onMoveShouldSetResponder();
  if (touchStart || touchMove) return true;
  return touchStart === undefined && touchMove === undefined;
};
var findEventHandler = function findEventHandler(element, eventName, callsite, nearestTouchResponder) {
  var touchResponder = isTouchResponder(element) ? element : nearestTouchResponder;
  var handler = getEventHandler(element, eventName);
  if (handler && isEventEnabled(element, touchResponder, eventName)) return handler;
  if (element.parent === null || element.parent.parent === null) {
    return null;
  }
  return findEventHandler(element.parent, eventName, callsite, touchResponder);
};
var getEventHandler = function getEventHandler(element, eventName) {
  var eventHandlerName = toEventHandlerName(eventName);
  if (typeof element.props[eventHandlerName] === 'function') {
    return element.props[eventHandlerName];
  }
  if (typeof element.props[eventName] === 'function') {
    return element.props[eventName];
  }
  return undefined;
};
var invokeEvent = function invokeEvent(element, eventName, callsite) {
  for (var _len = arguments.length, data = new Array(_len > 3 ? _len - 3 : 0), _key = 3; _key < _len; _key++) {
    data[_key - 3] = arguments[_key];
  }
  var handler = findEventHandler(element, eventName, callsite);
  if (!handler) {
    return;
  }
  var returnValue;
  (0, _act.default)(function () {
    returnValue = handler.apply(void 0, data);
  });
  return returnValue;
};
var toEventHandlerName = function toEventHandlerName(eventName) {
  return "on" + eventName.charAt(0).toUpperCase() + eventName.slice(1);
};
var pressHandler = function pressHandler(element) {
  for (var _len2 = arguments.length, data = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
    data[_key2 - 1] = arguments[_key2];
  }
  return invokeEvent.apply(void 0, [element, 'press', pressHandler].concat(data));
};
var changeTextHandler = function changeTextHandler(element) {
  for (var _len3 = arguments.length, data = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {
    data[_key3 - 1] = arguments[_key3];
  }
  return invokeEvent.apply(void 0, [element, 'changeText', changeTextHandler].concat(data));
};
var scrollHandler = function scrollHandler(element) {
  for (var _len4 = arguments.length, data = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {
    data[_key4 - 1] = arguments[_key4];
  }
  return invokeEvent.apply(void 0, [element, 'scroll', scrollHandler].concat(data));
};
var fireEvent = function fireEvent(element, eventName) {
  for (var _len5 = arguments.length, data = new Array(_len5 > 2 ? _len5 - 2 : 0), _key5 = 2; _key5 < _len5; _key5++) {
    data[_key5 - 2] = arguments[_key5];
  }
  return invokeEvent.apply(void 0, [element, eventName, fireEvent].concat(data));
};
fireEvent.press = pressHandler;
fireEvent.changeText = changeTextHandler;
fireEvent.scroll = scrollHandler;
var _default = fireEvent;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QztBQUFBO0FBRTlEUSxTQUFTLENBQUNDLEtBQUssR0FBR0osWUFBWTtBQUM5QkcsU0FBUyxDQUFDRSxVQUFVLEdBQUdKLGlCQUFpQjtBQUN4Q0UsU0FBUyxDQUFDRyxNQUFNLEdBQUdKLGFBQWE7QUFBQyxlQUVsQkMsU0FBUztBQUFBSSIsIm5hbWVzIjpbImRlZmF1bHQiLCJpc1RleHRJbnB1dCIsImVsZW1lbnQiLCJUZXh0SW5wdXQiLCJ0ZXh0SW5wdXQiLCJpc1RvdWNoUmVzcG9uZGVyIiwicHJvcHMiLCJvblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIiwiaXNQb2ludGVyRXZlbnRFbmFibGVkIiwiaXNQYXJlbnQiLCJwYXJlbnRDb25kaXRpb24iLCJwb2ludGVyRXZlbnRzIiwicGFyZW50IiwiaXNUb3VjaEV2ZW50IiwiZXZlbnROYW1lIiwiaXNFdmVudEVuYWJsZWQiLCJ0b3VjaFJlc3BvbmRlciIsImVkaXRhYmxlIiwidG91Y2hTdGFydCIsInRvdWNoTW92ZSIsIm9uTW92ZVNob3VsZFNldFJlc3BvbmRlciIsInVuZGVmaW5lZCIsImZpbmRFdmVudEhhbmRsZXIiLCJjYWxsc2l0ZSIsIm5lYXJlc3RUb3VjaFJlc3BvbmRlciIsImhhbmRsZXIiLCJnZXRFdmVudEhhbmRsZXIiLCJldmVudEhhbmRsZXJOYW1lIiwidG9FdmVudEhhbmRsZXJOYW1lIiwiaW52b2tlRXZlbnQiLCJkYXRhIiwicmV0dXJuVmFsdWUiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwicHJlc3NIYW5kbGVyIiwiY2hhbmdlVGV4dEhhbmRsZXIiLCJzY3JvbGxIYW5kbGVyIiwiZmlyZUV2ZW50IiwicHJlc3MiLCJjaGFuZ2VUZXh0Iiwic2Nyb2xsIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIi4uL3NyYy9maXJlRXZlbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVhY3RUZXN0SW5zdGFuY2UgfSBmcm9tICdyZWFjdC10ZXN0LXJlbmRlcmVyJztcbmltcG9ydCB7IFRleHRJbnB1dCB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5pbXBvcnQgYWN0IGZyb20gJy4vYWN0JztcbmltcG9ydCB7IGlzSG9zdEVsZW1lbnQgfSBmcm9tICcuL2hlbHBlcnMvY29tcG9uZW50LXRyZWUnO1xuaW1wb3J0IHsgZmlsdGVyTm9kZUJ5VHlwZSB9IGZyb20gJy4vaGVscGVycy9maWx0ZXJOb2RlQnlUeXBlJztcbmltcG9ydCB7IGdldEhvc3RDb21wb25lbnROYW1lcyB9IGZyb20gJy4vaGVscGVycy9ob3N0LWNvbXBvbmVudC1uYW1lcyc7XG5cbnR5cGUgRXZlbnRIYW5kbGVyID0gKC4uLmFyZ3M6IGFueSkgPT4gdW5rbm93bjtcblxuY29uc3QgaXNUZXh0SW5wdXQgPSAoZWxlbWVudD86IFJlYWN0VGVzdEluc3RhbmNlKSA9PiB7XG4gIGlmICghZWxlbWVudCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIFdlIGhhdmUgdG8gdGVzdCBpZiB0aGUgZWxlbWVudCB0eXBlIGlzIGVpdGhlciB0aGUgVGV4dElucHV0IGNvbXBvbmVudFxuICAvLyAod2hpY2ggd291bGQgaWYgaXQgaXMgYSBjb21wb3NpdGUgY29tcG9uZW50KSBvciB0aGUgc3RyaW5nXG4gIC8vIFRleHRJbnB1dCAod2hpY2ggd291bGQgYmUgdHJ1ZSBpZiBpdCBpcyBhIGhvc3QgY29tcG9uZW50KVxuICAvLyBBbGwgcXVlcmllcyByZXR1cm4gaG9zdCBjb21wb25lbnRzIGJ1dCBzaW5jZSBmaXJlRXZlbnQgYnViYmxlcyB1cFxuICAvLyBpdCB3b3VsZCB0cmlnZ2VyIHRoZSBwYXJlbnQgcHJvcCB3aXRob3V0IHRoZSBjb21wb3NpdGUgY29tcG9uZW50IGNoZWNrXG4gIHJldHVybiAoXG4gICAgZmlsdGVyTm9kZUJ5VHlwZShlbGVtZW50LCBUZXh0SW5wdXQpIHx8XG4gICAgZmlsdGVyTm9kZUJ5VHlwZShlbGVtZW50LCBnZXRIb3N0Q29tcG9uZW50TmFtZXMoKS50ZXh0SW5wdXQpXG4gICk7XG59O1xuXG5jb25zdCBpc1RvdWNoUmVzcG9uZGVyID0gKGVsZW1lbnQ/OiBSZWFjdFRlc3RJbnN0YW5jZSkgPT4ge1xuICBpZiAoIWlzSG9zdEVsZW1lbnQoZWxlbWVudCkpIHJldHVybiBmYWxzZTtcblxuICByZXR1cm4gISFlbGVtZW50Py5wcm9wcy5vblN0YXJ0U2hvdWxkU2V0UmVzcG9uZGVyIHx8IGlzVGV4dElucHV0KGVsZW1lbnQpO1xufTtcblxuY29uc3QgaXNQb2ludGVyRXZlbnRFbmFibGVkID0gKFxuICBlbGVtZW50PzogUmVhY3RUZXN0SW5zdGFuY2UsXG4gIGlzUGFyZW50PzogYm9vbGVhblxuKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IHBhcmVudENvbmRpdGlvbiA9IGlzUGFyZW50XG4gICAgPyBlbGVtZW50Py5wcm9wcy5wb2ludGVyRXZlbnRzID09PSAnYm94LW9ubHknXG4gICAgOiBlbGVtZW50Py5wcm9wcy5wb2ludGVyRXZlbnRzID09PSAnYm94LW5vbmUnO1xuXG4gIGlmIChlbGVtZW50Py5wcm9wcy5wb2ludGVyRXZlbnRzID09PSAnbm9uZScgfHwgcGFyZW50Q29uZGl0aW9uKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKCFlbGVtZW50Py5wYXJlbnQpIHJldHVybiB0cnVlO1xuXG4gIHJldHVybiBpc1BvaW50ZXJFdmVudEVuYWJsZWQoZWxlbWVudC5wYXJlbnQsIHRydWUpO1xufTtcblxuY29uc3QgaXNUb3VjaEV2ZW50ID0gKGV2ZW50TmFtZT86IHN0cmluZykgPT4ge1xuICByZXR1cm4gZXZlbnROYW1lID09PSAncHJlc3MnO1xufTtcblxuY29uc3QgaXNFdmVudEVuYWJsZWQgPSAoXG4gIGVsZW1lbnQ/OiBSZWFjdFRlc3RJbnN0YW5jZSxcbiAgdG91Y2hSZXNwb25kZXI/OiBSZWFjdFRlc3RJbnN0YW5jZSxcbiAgZXZlbnROYW1lPzogc3RyaW5nXG4pID0+IHtcbiAgaWYgKGlzVGV4dElucHV0KGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudD8ucHJvcHMuZWRpdGFibGUgIT09IGZhbHNlO1xuICBpZiAoIWlzUG9pbnRlckV2ZW50RW5hYmxlZChlbGVtZW50KSAmJiBpc1RvdWNoRXZlbnQoZXZlbnROYW1lKSkgcmV0dXJuIGZhbHNlO1xuXG4gIGNvbnN0IHRvdWNoU3RhcnQgPSB0b3VjaFJlc3BvbmRlcj8ucHJvcHMub25TdGFydFNob3VsZFNldFJlc3BvbmRlcj8uKCk7XG4gIGNvbnN0IHRvdWNoTW92ZSA9IHRvdWNoUmVzcG9uZGVyPy5wcm9wcy5vbk1vdmVTaG91bGRTZXRSZXNwb25kZXI/LigpO1xuXG4gIGlmICh0b3VjaFN0YXJ0IHx8IHRvdWNoTW92ZSkgcmV0dXJuIHRydWU7XG5cbiAgcmV0dXJuIHRvdWNoU3RhcnQgPT09IHVuZGVmaW5lZCAmJiB0b3VjaE1vdmUgPT09IHVuZGVmaW5lZDtcbn07XG5cbmNvbnN0IGZpbmRFdmVudEhhbmRsZXIgPSAoXG4gIGVsZW1lbnQ6IFJlYWN0VGVzdEluc3RhbmNlLFxuICBldmVudE5hbWU6IHN0cmluZyxcbiAgY2FsbHNpdGU/OiBhbnksXG4gIG5lYXJlc3RUb3VjaFJlc3BvbmRlcj86IFJlYWN0VGVzdEluc3RhbmNlXG4pOiBFdmVudEhhbmRsZXIgfCBudWxsID0+IHtcbiAgY29uc3QgdG91Y2hSZXNwb25kZXIgPSBpc1RvdWNoUmVzcG9uZGVyKGVsZW1lbnQpXG4gICAgPyBlbGVtZW50XG4gICAgOiBuZWFyZXN0VG91Y2hSZXNwb25kZXI7XG5cbiAgY29uc3QgaGFuZGxlciA9IGdldEV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUpO1xuICBpZiAoaGFuZGxlciAmJiBpc0V2ZW50RW5hYmxlZChlbGVtZW50LCB0b3VjaFJlc3BvbmRlciwgZXZlbnROYW1lKSlcbiAgICByZXR1cm4gaGFuZGxlcjtcblxuICBpZiAoZWxlbWVudC5wYXJlbnQgPT09IG51bGwgfHwgZWxlbWVudC5wYXJlbnQucGFyZW50ID09PSBudWxsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICByZXR1cm4gZmluZEV2ZW50SGFuZGxlcihlbGVtZW50LnBhcmVudCwgZXZlbnROYW1lLCBjYWxsc2l0ZSwgdG91Y2hSZXNwb25kZXIpO1xufTtcblxuY29uc3QgZ2V0RXZlbnRIYW5kbGVyID0gKFxuICBlbGVtZW50OiBSZWFjdFRlc3RJbnN0YW5jZSxcbiAgZXZlbnROYW1lOiBzdHJpbmdcbik6IEV2ZW50SGFuZGxlciB8IHVuZGVmaW5lZCA9PiB7XG4gIGNvbnN0IGV2ZW50SGFuZGxlck5hbWUgPSB0b0V2ZW50SGFuZGxlck5hbWUoZXZlbnROYW1lKTtcbiAgaWYgKHR5cGVvZiBlbGVtZW50LnByb3BzW2V2ZW50SGFuZGxlck5hbWVdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgcmV0dXJuIGVsZW1lbnQucHJvcHNbZXZlbnRIYW5kbGVyTmFtZV07XG4gIH1cblxuICBpZiAodHlwZW9mIGVsZW1lbnQucHJvcHNbZXZlbnROYW1lXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBlbGVtZW50LnByb3BzW2V2ZW50TmFtZV07XG4gIH1cblxuICByZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuY29uc3QgaW52b2tlRXZlbnQgPSAoXG4gIGVsZW1lbnQ6IFJlYWN0VGVzdEluc3RhbmNlLFxuICBldmVudE5hbWU6IHN0cmluZyxcbiAgY2FsbHNpdGU/OiBhbnksXG4gIC4uLmRhdGE6IEFycmF5PGFueT5cbikgPT4ge1xuICBjb25zdCBoYW5kbGVyID0gZmluZEV2ZW50SGFuZGxlcihlbGVtZW50LCBldmVudE5hbWUsIGNhbGxzaXRlKTtcblxuICBpZiAoIWhhbmRsZXIpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgcmV0dXJuVmFsdWU7XG5cbiAgYWN0KCgpID0+IHtcbiAgICByZXR1cm5WYWx1ZSA9IGhhbmRsZXIoLi4uZGF0YSk7XG4gIH0pO1xuXG4gIHJldHVybiByZXR1cm5WYWx1ZTtcbn07XG5cbmNvbnN0IHRvRXZlbnRIYW5kbGVyTmFtZSA9IChldmVudE5hbWU6IHN0cmluZykgPT5cbiAgYG9uJHtldmVudE5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCl9JHtldmVudE5hbWUuc2xpY2UoMSl9YDtcblxuY29uc3QgcHJlc3NIYW5kbGVyID0gKGVsZW1lbnQ6IFJlYWN0VGVzdEluc3RhbmNlLCAuLi5kYXRhOiBBcnJheTxhbnk+KTogdm9pZCA9PlxuICBpbnZva2VFdmVudChlbGVtZW50LCAncHJlc3MnLCBwcmVzc0hhbmRsZXIsIC4uLmRhdGEpO1xuY29uc3QgY2hhbmdlVGV4dEhhbmRsZXIgPSAoXG4gIGVsZW1lbnQ6IFJlYWN0VGVzdEluc3RhbmNlLFxuICAuLi5kYXRhOiBBcnJheTxhbnk+XG4pOiB2b2lkID0+IGludm9rZUV2ZW50KGVsZW1lbnQsICdjaGFuZ2VUZXh0JywgY2hhbmdlVGV4dEhhbmRsZXIsIC4uLmRhdGEpO1xuY29uc3Qgc2Nyb2xsSGFuZGxlciA9IChlbGVtZW50OiBSZWFjdFRlc3RJbnN0YW5jZSwgLi4uZGF0YTogQXJyYXk8YW55Pik6IHZvaWQgPT5cbiAgaW52b2tlRXZlbnQoZWxlbWVudCwgJ3Njcm9sbCcsIHNjcm9sbEhhbmRsZXIsIC4uLmRhdGEpO1xuXG5jb25zdCBmaXJlRXZlbnQgPSAoXG4gIGVsZW1lbnQ6IFJlYWN0VGVzdEluc3RhbmNlLFxuICBldmVudE5hbWU6IHN0cmluZyxcbiAgLi4uZGF0YTogQXJyYXk8YW55PlxuKTogdm9pZCA9PiBpbnZva2VFdmVudChlbGVtZW50LCBldmVudE5hbWUsIGZpcmVFdmVudCwgLi4uZGF0YSk7XG5cbmZpcmVFdmVudC5wcmVzcyA9IHByZXNzSGFuZGxlcjtcbmZpcmVFdmVudC5jaGFuZ2VUZXh0ID0gY2hhbmdlVGV4dEhhbmRsZXI7XG5maXJlRXZlbnQuc2Nyb2xsID0gc2Nyb2xsSGFuZGxlcjtcblxuZXhwb3J0IGRlZmF1bHQgZmlyZUV2ZW50O1xuIl19